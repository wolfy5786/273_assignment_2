services:

  # ── Kafka broker (KRaft combined mode – no Zookeeper) ───────
  kafka:
    image: apache/kafka:latest
    hostname: kafka
    container_name: kafka
    ports:
      - "9092:9092"       # host-accessible listener
      - "9093:9093"       # inter-container listener
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: CONTROLLER://kafka:29093,PLAINTEXT://kafka:9093,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9093,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:29093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_NUM_PARTITIONS: 3
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      CLUSTER_ID: "MkU3OEVBNTcwNTJENDM2Qk"
    healthcheck:
      test: /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9093 --list || exit 1
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 30s

  # ── Topic bootstrap (runs once then exits) ──────────────────
  init-topics:
    image: apache/kafka:latest
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Creating Kafka topics..."
        /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9093 --create --if-not-exists \
          --topic OrderEvents   --partitions 3 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9093 --create --if-not-exists \
          --topic InventoryEvents --partitions 3 --replication-factor 1
        echo "Topics created:"
        /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9093 --list

  # ── Producer (OrderService) ─────────────────────────────────
  producer-order:
    build:
      context: ..
      dockerfile: streaming_kafka/producer_order/Dockerfile
    ports:
      - "7001:7001"
    environment:
      - KAFKA_BOOTSTRAP=kafka:9093
    depends_on:
      init-topics:
        condition: service_completed_successfully

  # ── Inventory Consumer ──────────────────────────────────────
  inventory-consumer:
    build:
      context: ..
      dockerfile: streaming_kafka/inventory_consumer/Dockerfile
    environment:
      - KAFKA_BOOTSTRAP=kafka:9093
      - CONSUMER_GROUP=inventory-group
      - THROTTLE_MS=0
    depends_on:
      init-topics:
        condition: service_completed_successfully

  # ── Analytics Consumer ──────────────────────────────────────
  analytics-consumer:
    build:
      context: ..
      dockerfile: streaming_kafka/analytics_consumer/Dockerfile
    ports:
      - "7002:7002"
    environment:
      - KAFKA_BOOTSTRAP=kafka:9093
      - CONSUMER_GROUP=analytics-group
    depends_on:
      init-topics:
        condition: service_completed_successfully
